<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report prodejců</title>
  <meta name="description" content="Osobní report pro sledování výkonu prodejců" />
  <style>
    :root{
      --bg0:#0f1116;
      --bg1:#161a22;

      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.18);

      --text:#f4f6fb;
      --muted:#b8c0d6;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadowSoft: 0 10px 30px rgba(0,0,0,.30);
      --radius: 18px;
      --radius2: 14px;
      --pad: 18px;

      --accent: #2bd670;
      --accent2:#1bcf62;

      --danger:#ff4d6d;
      --warn:#ffb020;

      --chipBg: rgba(255,255,255,.10);
      --chipBg2: rgba(255,255,255,.08);

      --inputBg: rgba(255,255,255,.07);
      --inputBg2: rgba(255,255,255,.06);
      --inputStroke: rgba(255,255,255,.15);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 30% -10%, rgba(43,214,112,.22), transparent 55%),
        radial-gradient(900px 600px at 100% 0%, rgba(59,130,246,.14), transparent 52%),
        radial-gradient(900px 650px at 60% 115%, rgba(168,85,247,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 26px 18px 46px;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    h1{
      margin: 2px 0 0;
      font-weight: 700;
      font-size: 30px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width:560px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
      padding-top:4px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      font-size: 12.5px;
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(10px);
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    .btn:active{transform: translateY(0)}
    .btn.primary{
      border-color: rgba(43,214,112,.35);
      background: linear-gradient(180deg, rgba(43,214,112,.22), rgba(43,214,112,.12));
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
    }
    .btn.danger{
      border-color: rgba(255,77,109,.35);
      background: linear-gradient(180deg, rgba(255,77,109,.20), rgba(255,77,109,.10));
    }

    .layout{
      display:grid;
      grid-template-columns: 410px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .toolbar{justify-content:flex-start}
    }

    .card{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .cardInner{padding: var(--pad)}
    .cardTitle{
      font-weight: 800;
      letter-spacing:.6px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      margin: 0 0 12px;
      text-transform: uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      margin: 0 0 6px;
      letter-spacing:.2px;
    }
    select,input,textarea{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--inputStroke);
      background: linear-gradient(180deg, var(--inputBg), var(--inputBg2));
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    input[type="date"]{padding: 9px 12px}
    textarea{
      resize:vertical;
      min-height: 80px;
      line-height:1.35;
    }
    ::placeholder{color: rgba(255,255,255,.35)}
    select:focus,input:focus,textarea:focus{
      border-color: rgba(43,214,112,.45);
      box-shadow: 0 0 0 3px rgba(43,214,112,.12);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, var(--chipBg), var(--chipBg2));
      color: rgba(255,255,255,.90);
      font-size: 12.5px;
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .chip .k{color: rgba(255,255,255,.62); font-weight:700; letter-spacing:.2px}
    .chip .v{font-weight:800}
    .chipGroup{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .avatar{
      width:56px;
      height:56px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      display:grid;
      place-items:center;
      box-shadow: var(--shadowSoft);
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar span{
      font-weight: 900;
      letter-spacing: .4px;
      color: rgba(255,255,255,.85);
      font-size: 12px;
    }

    .statsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .statsGrid{grid-template-columns: 1fr 1fr 1fr}
    }
    @media (max-width: 520px){
      .statsGrid{grid-template-columns: 1fr}
    }
    .stat{
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--radius2);
      padding: 12px 12px;
      box-shadow: var(--shadowSoft);
    }
    .stat .t{
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 700;
      letter-spacing:.2px;
      margin-bottom:6px;
    }
    .stat .n{
      font-size: 28px;
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .stat .n span{
      font-size: 14px;
      color: rgba(255,255,255,.70);
      font-weight: 800;
    }
    .stat.good .n{color: var(--accent)}
    .stat.bad .n{color: var(--danger)}
    .stat.neutral .n{color: rgba(255,255,255,.92)}

    .chartWrap{
      margin-top: 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      padding: 12px;
      overflow:hidden;
    }
    canvas{max-width:100%}

    .tableWrap{
      margin-top: 14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size: 13px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight:800;
      background: rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    tbody td{
      padding: 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
    }
    tbody tr:last-child td{border-bottom:none}
    .right{ text-align:right }

    .note{
      margin-top: 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius2);
      overflow:hidden;
      background: rgba(255,255,255,.05);
    }
    details.note details{display:block}
    details.note summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 12px;
      font-weight:800;
      color: rgba(255,255,255,.86);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    details.note summary::-webkit-details-marker{display:none}
    .noteBody{
      padding: 0 12px 12px;
      color: rgba(255,255,255,.82);
      font-size: 13px;
      line-height:1.35;
    }

    .smallHint{
      font-size: 11.5px;
      color: rgba(255,255,255,.55);
      margin-top: 8px;
      line-height:1.35;
    }

    .footerHint{
      margin-top: 10px;
      color: rgba(255,255,255,.45);
      font-size: 11.5px;
    }

    .twoBtnRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .twoBtnRow{grid-template-columns: 1fr}
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.76);
      font-size: 12px;
      font-weight: 700;
      gap:8px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div>
        <h1>Report prodejců</h1>
        <div class="sub">Aplikaci vytvořil a publikuje Radek Tlachač. Obsah ani řešení není dovoleno kopírovat nebo dále šířit bez souhlasu autora.</div>
      </div>

      <div class="toolbar">
        <button class="btn ghost" id="exportExcelBtn" type="button">Export do Excelu záznamy</button>
        <button class="btn ghost" id="exportImageBtn" type="button">Export obrázek reportu</button>
      </div>
    </div>

    <div class="layout">

      <div class="card">
        <div class="cardInner">
          <div class="cardTitle">Vstup DAT</div>

          <div class="grid2">
            <div>
              <label for="rveSelect">RVE</label>
              <select id="rveSelect"></select>
            </div>
            <div>
              <label for="storeSelect">Prodejna</label>
              <select id="storeSelect"></select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="sellerSelect">Prodejce</label>
            <select id="sellerSelect"></select>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label for="dateInput">Datum</label>
              <input id="dateInput" type="date" />
            </div>
            <div>
              <label for="valueInput">Podíl na tržbě s DPH (služby)</label>
              <input id="valueInput" type="number" min="0" step="0.01" placeholder="např. 6.30" />
            </div>
          </div>

          <div class="twoBtnRow">
            <button class="btn primary" id="addRecordBtn" type="button">Přidat záznam</button>
            <button class="btn ghost" id="openReportBtn" type="button">Správa prodejců</button>
            <button class="btn ghost" id="openTrainingBtn" type="button">Zapsat trénink</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn ghost" id="clearBtn" type="button">Smazat všechna data</button>
          </div>

          <div class="hr"></div>

          <div class="cardTitle" style="margin-bottom:10px;">Report</div>

          <div class="row" style="gap:14px;">
            <div class="avatar" id="avatarBox"><span id="avatarTxt">?</span></div>
            <div style="flex:1; min-width:220px;">
              <div class="chipGroup" style="margin-bottom:10px;">
                <span class="chip"><span class="k">Vyber prodejce</span></span>
                <span class="chip"><span class="k">Prodejna</span></span>
                <span class="chip"><span class="k">RVE</span></span>
              </div>

              <div class="chipGroup">
                <span class="chip"><span class="k">Trénink celkem</span><span class="v" id="trainTotal">0</span><span class="k">h</span></span>
                <span class="chip"><span class="k">Průměr na trénink</span><span class="v" id="trainAvg">0</span><span class="k">h</span></span>
                <span class="chip"><span class="k">Počet tréninků</span><span class="v" id="trainCount">0</span></span>
              </div>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div>
              <label for="fromDate">Od</label>
              <input id="fromDate" type="date" />
            </div>
            <div>
              <label for="toDate">Do</label>
              <input id="toDate" type="date" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <button class="btn primary" id="recalcBtn" type="button">Přepočítat</button>
          </div>

          <div class="statsGrid">
            <div class="stat neutral">
              <div class="t">Aktuální období</div>
              <div class="n"><span id="currentPct">0</span><span>%</span></div>
            </div>
            <div class="stat neutral">
              <div class="t">Minulé období</div>
              <div class="n"><span id="prevPct">0</span><span>%</span></div>
            </div>
            <div class="stat neutral" id="changeStat">
              <div class="t">Změna</div>
              <div class="n"><span id="changePct">0</span><span>%</span></div>
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="cardInner">

          <div class="chartWrap">
            <canvas id="chart" height="240"></canvas>
          </div>

          <div class="tableWrap" style="margin-top:16px;">
            <div class="cardInner" style="padding: 14px 14px 10px;">
              <div class="cardTitle" style="margin:0;">Záznamy v období</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Prodejce</th>
                  <th>Prodejna</th>
                  <th class="right">Hodnota</th>
                </tr>
              </thead>
              <tbody id="recordsBody"></tbody>
            </table>

            <div class="cardInner" style="padding: 14px;">
              <div class="cardTitle" style="margin:0 0 10px;">Tréninky v období</div>

              <details class="note" id="trainingNote">
                <summary>
                  <span id="trainingNoteTitle">Poznámka k tréninku</span>
                  <span class="pill">Rozbalit</span>
                </summary>
                <div class="noteBody" id="trainingNoteBody">Zatím není zapsaná žádná poznámka.</div>
              </details>

              <div class="smallHint" id="trainingHint"></div>
            </div>
          </div>

          <div class="footerHint">Data se ukládají lokálně v prohlížeči. Pokud chceš sdílení napříč zařízeními, napiš a uděláme synchronizaci.</div>
        </div>
      </div>

    </div>
  </div>

  <div class="card" id="modalReport" style="position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.55); backdrop-filter: blur(10px); padding: 18px; z-index: 50;">
    <div class="card" style="max-width: 760px; width:100%;">
      <div class="cardInner">
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
          <div style="font-weight:900; letter-spacing:.3px;">Správa prodejců</div>
          <button class="btn ghost" id="closeReportModal" type="button">Zavřít</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>RVE</label>
            <input id="newRve" placeholder="např. HK" />
          </div>
          <div>
            <label>Prodejna</label>
            <input id="newStore" placeholder="např. DATF Dvůr Králové Erbenova" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>Prodejce</label>
            <input id="newSeller" placeholder="např. Daniel Klust" />
          </div>
          <div>
            <label>Iniciály</label>
            <input id="newInitials" placeholder="např. DK" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="addSellerBtn" type="button">Přidat</button>
        </div>

        <div class="hr"></div>

        <div class="cardTitle" style="margin-bottom:8px;">Seznam prodejců</div>
        <div id="sellerList"></div>

        <div class="smallHint">Poznámka: Pokud smažeš prodejce, smažou se i jeho záznamy.</div>
      </div>
    </div>
  </div>

  <div class="card" id="modalTraining" style="position:fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,.55); backdrop-filter: blur(10px); padding: 18px; z-index: 60;">
    <div class="card" style="max-width: 760px; width:100%;">
      <div class="cardInner">
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
          <div style="font-weight:900; letter-spacing:.3px;">Zapsat trénink</div>
          <button class="btn ghost" id="closeTrainingModal" type="button">Zavřít</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="trainDate">Datum</label>
            <input id="trainDate" type="date" />
          </div>
          <div>
            <label for="trainHours">Délka (hodiny)</label>
            <input id="trainHours" type="number" min="0" step="0.5" placeholder="např. 2" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="trainNote">Poznámka</label>
          <textarea id="trainNote" placeholder="např. Trénink byl hlavně na prodej služeb"></textarea>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="saveTrainingBtn" type="button">Uložit trénink</button>
        </div>

        <div class="smallHint">Trénink se uloží pod vybraného prodejce. V reportu se pak zobrazí v části Tréninky v období.</div>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "report_prodejcu_data_v4";

    const el = (id)=>document.getElementById(id);

    const rveSelect = el("rveSelect");
    const storeSelect = el("storeSelect");
    const sellerSelect = el("sellerSelect");
    const dateInput = el("dateInput");
    const valueInput = el("valueInput");

    const addRecordBtn = el("addRecordBtn");
    const clearBtn = el("clearBtn");
    const recalcBtn = el("recalcBtn");

    const fromDate = el("fromDate");
    const toDate = el("toDate");

    const currentPct = el("currentPct");
    const prevPct = el("prevPct");
    const changePct = el("changePct");
    const changeStat = el("changeStat");

    const recordsBody = el("recordsBody");

    const avatarTxt = el("avatarTxt");

    const trainTotal = el("trainTotal");
    const trainAvg = el("trainAvg");
    const trainCount = el("trainCount");

    const exportExcelBtn = el("exportExcelBtn");
    const exportImageBtn = el("exportImageBtn");

    const openReportBtn = el("openReportBtn");
    const modalReport = el("modalReport");
    const closeReportModal = el("closeReportModal");
    const addSellerBtn = el("addSellerBtn");
    const newRve = el("newRve");
    const newStore = el("newStore");
    const newSeller = el("newSeller");
    const newInitials = el("newInitials");
    const sellerList = el("sellerList");

    const openTrainingBtn = el("openTrainingBtn");
    const modalTraining = el("modalTraining");
    const closeTrainingModal = el("closeTrainingModal");
    const trainDate = el("trainDate");
    const trainHours = el("trainHours");
    const trainNote = el("trainNote");
    const saveTrainingBtn = el("saveTrainingBtn");

    const trainingNote = el("trainingNote");
    const trainingNoteTitle = el("trainingNoteTitle");
    const trainingNoteBody = el("trainingNoteBody");
    const trainingHint = el("trainingHint");

    const chartCanvas = el("chart");
    const ctx = chartCanvas.getContext("2d");

    const defaultData = {
      sellers: [
        { id: crypto.randomUUID(), rve: "HK", store: "DATF Dvůr Králové Erbenova", name: "Daniel Klust", initials: "DK" },
        { id: crypto.randomUUID(), rve: "HK", store: "DAT Hradec Králové Aupark", name: "Karásek Jaroslav", initials: "KJ" }
      ],
      records: [],
      trainings: []
    };

    function loadData(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultData);
        const parsed = JSON.parse(raw);
        if(!parsed || !parsed.sellers) return structuredClone(defaultData);
        parsed.records ||= [];
        parsed.trainings ||= [];
        return parsed;
      }catch(e){
        return structuredClone(defaultData);
      }
    }

    function saveData(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function fmtPct(n){
      const v = Number(n || 0);
      return v.toFixed(2).replace(".", ",");
    }

    function fmtDate(d){
      if(!d) return "";
      const [y,m,day] = d.split("-");
      return `${day}.${m}.${y}`;
    }

    function initialsFor(name){
      if(!name) return "?";
      const parts = name.trim().split(/\s+/).filter(Boolean);
      const a = (parts[0]?.[0] || "").toUpperCase();
      const b = (parts[1]?.[0] || "").toUpperCase();
      return (a + b) || "?";
    }

    function unique(list){
      return [...new Set(list)];
    }

    function fillSelect(select, items, valueGetter, labelGetter, placeholder){
      select.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder || "Vyber";
      select.appendChild(opt0);

      items.forEach(item=>{
        const opt = document.createElement("option");
        opt.value = valueGetter(item);
        opt.textContent = labelGetter(item);
        select.appendChild(opt);
      });
    }

    function computeFilters(){
      const rve = rveSelect.value;
      const store = storeSelect.value;
      const sellers = state.sellers
        .filter(s => !rve || s.rve === rve)
        .filter(s => !store || s.store === store);

      const rves = unique(state.sellers.map(s=>s.rve)).sort();
      const stores = unique(state.sellers.filter(s=>!rve || s.rve===rve).map(s=>s.store)).sort();

      fillSelect(rveSelect, rves, x=>x, x=>x, "RVE");
      if(rve) rveSelect.value = rve;

      fillSelect(storeSelect, stores, x=>x, x=>x, "Prodejna");
      if(store) storeSelect.value = store;

      fillSelect(sellerSelect, sellers, s=>s.id, s=>s.name, "Vyber prodejce");
    }

    function getSelectedSeller(){
      const id = sellerSelect.value;
      if(!id) return null;
      return state.sellers.find(s=>s.id===id) || null;
    }

    function dateInRange(d, a, b){
      if(!d) return false;
      if(a && d < a) return false;
      if(b && d > b) return false;
      return true;
    }

    function calc(){
      const seller = getSelectedSeller();
      const a = fromDate.value;
      const b = toDate.value;

      recordsBody.innerHTML = "";

      if(!seller){
        avatarTxt.textContent = "?";
        currentPct.textContent = "0";
        prevPct.textContent = "0";
        changePct.textContent = "0";
        trainTotal.textContent = "0";
        trainAvg.textContent = "0";
        trainCount.textContent = "0";
        trainingNoteBody.textContent = "Zatím není zapsaná žádná poznámka.";
        trainingNoteTitle.textContent = "Poznámka k tréninku";
        trainingHint.textContent = "";
        drawChart([]);
        return;
      }

      avatarTxt.textContent = seller.initials || initialsFor(seller.name);

      const recs = state.records
        .filter(r=>r.sellerId===seller.id)
        .filter(r=>dateInRange(r.date, a, b))
        .sort((x,y)=>x.date.localeCompare(y.date));

      recs.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtDate(r.date)}</td>
          <td>${escapeHtml(seller.name)}</td>
          <td>${escapeHtml(seller.store)}</td>
          <td class="right">${fmtPct(r.value)} %</td>
        `;
        recordsBody.appendChild(tr);
      });

      const current = average(recs.map(r=>Number(r.value)));

      const prevA = shiftMonths(a || todayISO(), -1);
      const prevB = shiftMonths(b || todayISO(), -1);

      const prevRecs = state.records
        .filter(r=>r.sellerId===seller.id)
        .filter(r=>dateInRange(r.date, prevA, prevB));

      const prev = average(prevRecs.map(r=>Number(r.value)));

      currentPct.textContent = fmtPct(current);
      prevPct.textContent = fmtPct(prev);

      const ch = (prev === 0) ? (current === 0 ? 0 : 100) : ((current - prev) / Math.abs(prev)) * 100;
      changePct.textContent = fmtPct(ch);

      changeStat.classList.remove("good","bad","neutral");
      if(ch > 0.0001) changeStat.classList.add("good");
      else if(ch < -0.0001) changeStat.classList.add("bad");
      else changeStat.classList.add("neutral");

      const trains = state.trainings
        .filter(t=>t.sellerId===seller.id)
        .filter(t=>dateInRange(t.date, a, b))
        .sort((x,y)=>x.date.localeCompare(y.date));

      const totalH = trains.reduce((sum,t)=>sum + Number(t.hours||0), 0);
      const cnt = trains.length;
      const avg = cnt ? (totalH / cnt) : 0;

      trainTotal.textContent = round1(totalH);
      trainCount.textContent = String(cnt);
      trainAvg.textContent = round1(avg);

      if(cnt){
        const last = trains[trains.length-1];
        trainingNoteTitle.textContent = `${fmtDate(last.date)}  ${round1(last.hours)} h`;
        trainingNoteBody.textContent = last.note ? last.note : "Poznámka nebyla vyplněna.";
        trainingHint.textContent = `V období je celkem ${cnt} tréninků. Zobrazuje se poslední poznámka.`;
      }else{
        trainingNoteTitle.textContent = "Poznámka k tréninku";
        trainingNoteBody.textContent = "V období není žádný trénink.";
        trainingHint.textContent = "";
      }

      drawChart(recs.map(r=>({date:r.date, value:Number(r.value)})));
    }

    function average(arr){
      if(!arr.length) return 0;
      const sum = arr.reduce((a,b)=>a+b,0);
      return sum / arr.length;
    }

    function round1(n){
      const v = Number(n || 0);
      const r = Math.round(v*10)/10;
      return String(r).replace(".", ",");
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function shiftMonths(iso, delta){
      if(!iso) return "";
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(y, m-1+delta, d);
      const yy = dt.getFullYear();
      const mm = String(dt.getMonth()+1).padStart(2,"0");
      const dd = String(dt.getDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function drawChart(points){
      const w = chartCanvas.width = chartCanvas.clientWidth * devicePixelRatio;
      const h = chartCanvas.height = 240 * devicePixelRatio;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(devicePixelRatio, devicePixelRatio);

      const W = chartCanvas.clientWidth;
      const H = 240;

      ctx.clearRect(0,0,W,H);

      const padX = 36;
      const padY = 26;

      ctx.globalAlpha = 1;

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padX, padY);
      ctx.lineTo(padX, H-padY);
      ctx.lineTo(W-padX, H-padY);
      ctx.stroke();

      if(!points.length){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "12px system-ui";
        ctx.fillText("Podíl na tržbě s DPH (služby)", padX+8, padY+6);
        return;
      }

      const xs = points.map((p,i)=>i);
      const ys = points.map(p=>p.value);

      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const y0 = Math.floor(Math.min(minY, 0));
      const y1 = Math.ceil(Math.max(maxY, 1));

      const xMin = 0;
      const xMax = points.length-1;

      const xScale = (i)=> padX + ( (i - xMin) / Math.max(1,(xMax-xMin)) ) * (W - padX*2);
      const yScale = (v)=> (H-padY) - ( (v - y0) / Math.max(1,(y1-y0)) ) * (H - padY*2);

      for(let t=0;t<=4;t++){
        const yVal = y0 + (t/4)*(y1-y0);
        const y = yScale(yVal);
        ctx.strokeStyle = "rgba(255,255,255,.08)";
        ctx.beginPath();
        ctx.moveTo(padX, y);
        ctx.lineTo(W-padX, y);
        ctx.stroke();

        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "11px system-ui";
        ctx.fillText(String(Math.round(yVal))+" %", 6, y+4);
      }

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "12px system-ui";
      ctx.fillText("Podíl na tržbě s DPH (služby)", padX+8, padY+6);

      ctx.strokeStyle = "rgba(43,214,112,.95)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p,i)=>{
        const x = xScale(i);
        const y = yScale(p.value);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      points.forEach((p,i)=>{
        const x = xScale(i);
        const y = yScale(p.value);
        ctx.fillStyle = "rgba(43,214,112,.95)";
        ctx.beginPath();
        ctx.arc(x,y,3.5,0,Math.PI*2);
        ctx.fill();
      });

      const iMid = Math.floor(points.length/2);
      const showIdx = [0, iMid, points.length-1].filter((v,i,a)=>a.indexOf(v)===i);

      showIdx.forEach(i=>{
        const p = points[i];
        const x = xScale(i);
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "11px system-ui";
        ctx.textAlign = "center";
        ctx.fillText(fmtDate(p.date), x, H-8);
      });
      ctx.textAlign = "start";
    }

    function addRecord(){
      const seller = getSelectedSeller();
      if(!seller) return alert("Vyber prodejce.");
      const d = dateInput.value;
      const v = Number(valueInput.value);
      if(!d) return alert("Vyber datum.");
      if(!Number.isFinite(v)) return alert("Zadej hodnotu.");

      state.records.push({
        id: crypto.randomUUID(),
        sellerId: seller.id,
        date: d,
        value: v
      });
      saveData();
      valueInput.value = "";
      calc();
    }

    function clearAll(){
      if(!confirm("Opravdu chceš smazat všechna data včetně prodejců, záznamů a tréninků?")) return;
      state = structuredClone(defaultData);
      saveData();
      init();
    }

    function exportExcelRecords(){
      const seller = getSelectedSeller();
      if(!seller) return alert("Vyber prodejce.");
      const a = fromDate.value;
      const b = toDate.value;

      const rows = state.records
        .filter(r=>r.sellerId===seller.id)
        .filter(r=>dateInRange(r.date, a, b))
        .sort((x,y)=>x.date.localeCompare(y.date))
        .map(r=>({
          Datum: fmtDate(r.date),
          Prodejce: seller.name,
          Prodejna: seller.store,
          Hodnota: fmtPct(r.value) + " %"
        }));

      if(!rows.length) return alert("V období nejsou žádné záznamy.");

      const csv = toCsv(rows);
      downloadText(csv, "REPORT_ENTRY.csv", "text/csv;charset=utf-8");
    }

    function toCsv(rows){
      const headers = Object.keys(rows[0]);
      const escape = (x)=> {
        const s = String(x ?? "");
        if(/[",\n;]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      const lines = [];
      lines.push(headers.map(escape).join(";"));
      rows.forEach(r=>{
        lines.push(headers.map(h=>escape(r[h])).join(";"));
      });
      return "\uFEFF" + lines.join("\n");
    }

    function downloadText(text, filename, mime){
      const blob = new Blob([text], {type: mime || "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function exportImage(){
      const seller = getSelectedSeller();
      if(!seller) return alert("Vyber prodejce.");

      const root = document.querySelector(".wrap");
      const dataUrl = await htmlToPng(root);

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "report.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function htmlToPng(root){
      const width = root.scrollWidth;
      const height = root.scrollHeight;

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
          <foreignObject width="100%" height="100%">
            ${new XMLSerializer().serializeToString(root.cloneNode(true))}
          </foreignObject>
        </svg>
      `;

      const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const img = new Image();
      img.decoding = "async";
      const p = new Promise((res,rej)=>{
        img.onload = ()=>res();
        img.onerror = (e)=>rej(e);
      });
      img.src = url;
      await p;

      const canvas = document.createElement("canvas");
      canvas.width = width * 2;
      canvas.height = height * 2;
      const c = canvas.getContext("2d");
      c.scale(2,2);

      c.fillStyle = "#0f1116";
      c.fillRect(0,0,width,height);
      c.drawImage(img,0,0);

      URL.revokeObjectURL(url);
      return canvas.toDataURL("image/png");
    }

    function openModal(modal){
      modal.style.display = "grid";
    }
    function closeModal(modal){
      modal.style.display = "none";
    }

    function renderSellerList(){
      sellerList.innerHTML = "";
      if(!state.sellers.length){
        sellerList.innerHTML = '<div class="smallHint">Zatím nejsou žádní prodejci.</div>';
        return;
      }
      state.sellers.forEach(s=>{
        const box = document.createElement("div");
        box.className = "row";
        box.style.justifyContent = "space-between";
        box.style.padding = "10px 0";
        box.style.borderBottom = "1px solid rgba(255,255,255,.08)";
        box.innerHTML = `
          <div style="min-width:260px">
            <div style="font-weight:800">${escapeHtml(s.name)}</div>
            <div style="color: rgba(255,255,255,.55); font-size: 12px; margin-top:2px;">${escapeHtml(s.rve)}  ${escapeHtml(s.store)}  ${escapeHtml(s.initials || "")}</div>
          </div>
          <div class="row">
            <button class="btn danger" type="button">Smazat</button>
          </div>
        `;
        const btn = box.querySelector("button");
        btn.addEventListener("click", ()=>{
          if(!confirm("Opravdu chceš smazat prodejce a jeho data?")) return;
          state.sellers = state.sellers.filter(x=>x.id!==s.id);
          state.records = state.records.filter(r=>r.sellerId!==s.id);
          state.trainings = state.trainings.filter(t=>t.sellerId!==s.id);
          saveData();
          init();
          renderSellerList();
        });
        sellerList.appendChild(box);
      });
    }

    function addSeller(){
      const rve = newRve.value.trim();
      const store = newStore.value.trim();
      const name = newSeller.value.trim();
      const initials = newInitials.value.trim().toUpperCase();

      if(!rve || !store || !name) return alert("Vyplň RVE, prodejnu a prodejce.");

      state.sellers.push({
        id: crypto.randomUUID(),
        rve,
        store,
        name,
        initials: initials || initialsFor(name)
      });
      saveData();

      newRve.value = "";
      newStore.value = "";
      newSeller.value = "";
      newInitials.value = "";

      init();
      renderSellerList();
    }

    function saveTraining(){
      const seller = getSelectedSeller();
      if(!seller) return alert("Nejdřív vyber prodejce.");
      const d = trainDate.value;
      const h = Number(trainHours.value);
      const n = trainNote.value.trim();

      if(!d) return alert("Vyber datum tréninku.");
      if(!Number.isFinite(h) || h < 0) return alert("Zadej délku tréninku v hodinách.");

      state.trainings.push({
        id: crypto.randomUUID(),
        sellerId: seller.id,
        date: d,
        hours: h,
        note: n
      });
      saveData();

      trainDate.value = "";
      trainHours.value = "";
      trainNote.value = "";

      closeModal(modalTraining);
      calc();
    }

    function init(){
      computeFilters();

      const seller = getSelectedSeller();
      if(!seller && state.sellers.length){
        sellerSelect.value = state.sellers[0].id;
      }

      if(!fromDate.value) fromDate.value = shiftMonths(todayISO(), -3);
      if(!toDate.value) toDate.value = todayISO();

      calc();
    }

    let state = loadData();

    rveSelect.addEventListener("change", ()=>{
      computeFilters();
      sellerSelect.value = "";
      calc();
    });
    storeSelect.addEventListener("change", ()=>{
      computeFilters();
      sellerSelect.value = "";
      calc();
    });
    sellerSelect.addEventListener("change", ()=>calc());
    fromDate.addEventListener("change", ()=>calc());
    toDate.addEventListener("change", ()=>calc());

    addRecordBtn.addEventListener("click", addRecord);
    clearBtn.addEventListener("click", clearAll);
    recalcBtn.addEventListener("click", calc);

    exportExcelBtn.addEventListener("click", exportExcelRecords);
    exportImageBtn.addEventListener("click", exportImage);

    openReportBtn.addEventListener("click", ()=>{
      openModal(modalReport);
      renderSellerList();
    });
    closeReportModal.addEventListener("click", ()=>closeModal(modalReport));
    addSellerBtn.addEventListener("click", addSeller);

    openTrainingBtn.addEventListener("click", ()=>{
      openModal(modalTraining);
      trainDate.value = todayISO();
    });
    closeTrainingModal.addEventListener("click", ()=>closeModal(modalTraining));
    saveTrainingBtn.addEventListener("click", saveTraining);

    window.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        closeModal(modalReport);
        closeModal(modalTraining);
      }
    });

    init();
  </script>
</body>
</html>
